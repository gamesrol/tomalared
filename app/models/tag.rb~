class Tag < ActiveRecord::Base
  has_and_belongs_to_many :posts, :order => 'created_at DESC'
  has_and_belongs_to_many :users, :join_table => 'users_tags'

# get rid of any tags that aren't attached to a post
  def self.prune_tags
    find(:all, :include => [:posts]).each { |t| t.destroy if t.posts.size == 0 }
  end

  def self.find_most_popular(limit = 5)
    find_by_sql("SELECT t.*, count(1) count FROM posts_tags pt 
                 JOIN tags t ON t.id = pt.tag_id GROUP BY tag_id 
                 ORDER BY count DESC LIMIT #{limit}")
  end
  
  def self.tag_users(tag, user)
      find_by_sql("SELECT user_id FROM tags_users WHERE tag_id = #{tag} AND user_id = #{user}")
  end
end
